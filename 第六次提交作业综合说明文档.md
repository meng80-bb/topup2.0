# 第六次提交作业综合说明文档

## 文档说明

本文档详细说明了BESIII离线事件滤波器校准流程中**第六次提交作业**（步骤6.1-6.2）的目的、意义、技术实现和物理背景。

**目标读者：** 新用户、需要了解项目背景的开发者、iFlow CLI参考文档

**相关文件：**
- 步骤6.1：`step6_1_sixth_job_submission.py` - 第六次作业提交与文件检查
- 步骤6.2：`step6_2_merge_images.py` - 合并图片
- genJob.sh：作业生成脚本
- checkCalibConst.cpp：C++分析程序
- 操作手册：`A-topup操作.docx`
- 论文：`OfflineEventFilter_rdtm2022.pdf`

---

## 一、第六次提交作业概述

### 什么是第六次提交作业？

第六次提交作业是BESIII离线事件滤波器校准流程的**最后一步**，其核心任务是**验证ETS_cut滤波器的校准效果**，通过对比应用滤波前后的MDC和EMC响应，确认滤波器能够有效去除注入背景污染。

### 在整个流程中的位置

第六次提交作业对应论文图5所示的离线数据处理流程中的 **"Offline Event Filter Calibration"**（离线事件滤波器校准）的验证阶段，是整个离线事件滤波器系统的**最终验证和质量保证**。

### 步骤6的子步骤关系

步骤6包含2个子步骤，形成一个完整的验证流程：

```
步骤6.1：第六次作业提交与文件检查（核心）
    ↓
步骤6.2：合并图片（人工审核）
```

**说明：**
- **步骤6.1**是核心，负责提交作业并生成验证图片
- **步骤6.2**是为了方便人工审核，合并所有验证图片
- 两个步骤共同构成完整的滤波器效果验证流程

---

## 二、第六次提交作业的物理背景

### 核心任务：验证滤波器效果

**滤波器校准流程回顾：**

在步骤5中，我们通过以下步骤确定了ETS_cut滤波器的参数：
1. **步骤5.1**：运行ETS_cut校准作业，分析每个run的ETS分布
2. **步骤5.2**：运行add_shield.sh脚本，应用shield滤波窗口
3. **步骤5.3**：整理ets_cut.txt文件，确定最终的ETS_cut范围
4. **步骤5.4**：生成ETS_cut校准图片

**第六次提交作业的作用：**

第六次提交作业的目的是**验证ETS_cut滤波器在实际数据中的效果**：
- 对比应用滤波前后的MDC和EMC响应
- 确认滤波器能够有效去除注入背景污染
- 验证滤波器参数的合理性
- 为最终提交滤波器参数到数据库做准备

### 物理意义

通过第六次提交作业，我们可以：
1. **验证滤波有效性**：确认滤波器确实去除了注入背景
2. **检查数据质量**：确保滤波后的数据符合物理分析要求
3. **优化滤波参数**：如果发现效果不佳，可以调整滤波窗口
4. **质量保证**：在提交数据库前进行最后的验证

---

## 三、第六次提交作业的核心目标

### 1. 应用ETS_cut滤波窗口

**什么是ETS_cut？**

ETS_cut是在步骤5中确定的ETS（Event Time Stamp）滤波窗口：
- **下限**：ETS值低于此值的事件被保留
- **上限**：ETS值高于此值的事件被保留
- **中间范围**：ETS值在此范围内的事件被过滤掉

**ETS_cut的作用：**

ETS_cut滤波器用于去除与注入事件相关的时间段：
- 注入事件通常具有特定的ETS特征
- 通过设置ETS_cut窗口，可以过滤掉这些事件
- 保留与注入无关的正常事件

### 2. 对比滤波前后的响应

**对比的内容：**

第六次提交作业会生成4种对比图：
1. **raw_ETS vs hit_TQ_MDC**：原始ETS vs MDC击中数
2. **afterCut_ETS vs hit_TQ_MDC**：应用滤波后的ETS vs MDC击中数
3. **raw_ETS vs nhit_all_emc**：原始ETS vs EMC击中数
4. **afterCut_ETS vs nhit_all_emc**：应用滤波后的ETS vs EMC击中数

**对比的物理意义：**

- **raw（原始）**：包含所有事件，包括注入背景
- **afterCut（滤波后）**：应用ETS_cut滤波后的事件
- **对比**：验证滤波器是否有效去除了注入背景

### 3. 验证滤波器效果

**验证标准：**

1. **背景峰值消失**：在ΔT = 0附近的背景峰值应该被有效去除
2. **数据保持完整**：正常事件的数据应该被完整保留
3. **响应分布正常**：滤波后的MDC和EMC响应分布应该符合预期
4. **无过度滤波**：不应该过滤掉正常的物理事件

### 4. 为最终提交做准备

**后续步骤：**

- 步骤7：运行reset.sh脚本，重置系统状态
- 步骤8：提交InjSigInterval到数据库
- 滤波器参数将在实际的事件重建中使用

---

## 四、genJob.sh脚本详解

### 脚本功能

`genJob.sh` 脚本是第六次提交作业的核心，负责：
1. 遍历hist目录中的所有hist文件
2. 为每个hist文件创建作业配置文件
3. 使用BOSS框架提交作业到计算集群

### 脚本内容详解

```bash
#!/bin/bash

pwdir=`pwd`
ntuplePath=/besfs5/groups/cal/topup/round${ROUND_NUMBER}/DataValid/hist
str="root"

for file in `/bin/ls ${ntuplePath}/hist*.root`;
do
	length=`expr ${#file} - 10`
	# echo "length" $length
	runNo=${file:$length:5}

	echo ${runNo}

	line="${pwdir}/a.out ${ntuplePath} ${runNo} "

	job=ETScut_check_${runNo}.txt

	#if [ -e $job ]; then
	#	echo "info: ${1} exists"
	#	continue
	#fi

	echo "$line" > "${job}"
	chmod +x ${job}
	hep_sub -g offlinerun ${job}

done
echo "DONE"
```

### 关键步骤说明

1. **路径设置：**
   - `pwdir`：当前工作目录
   - `ntuplePath`：hist文件目录，包含步骤2生成的hist文件

2. **遍历hist文件：**
   - 使用`/bin/ls ${ntuplePath}/hist*.root`获取所有hist文件
   - 从文件名中提取run编号

3. **提取run编号：**
   - `length=${#file} - 10`：计算文件名长度减去10
   - `runNo=${file:$length:5}`：从最后5个字符提取run编号

4. **生成作业配置文件：**
   - 创建`ETScut_check_${runNo}.txt`文件
   - 写入执行命令：`a.out ${ntuplePath} ${runNo}`
   - 设置可执行权限

5. **提交作业：**
   - 使用`hep_sub -g offlinerun ${job}`提交作业
   - 作业在计算集群上并行执行

---

## 五、checkCalibConst.cpp程序详解

### 程序功能

`checkCalibConst.cpp` 是一个C++程序，用于：
1. 读取hist文件中的事件数据
2. 从ets_cut.txt文件读取ETS_cut滤波窗口
3. 应用滤波窗口过滤事件
4. 生成对比图（滤波前后）
5. 保存结果到PNG和ROOT文件

### 程序关键部分详解

#### 1. 参数解析

```cpp
int run;
char path[200];
if(argc > 2){
    sscanf(argv[1], "%s", path);
    sscanf(argv[2], "%d", &run);
} else{
    cout << "too few arguments" << endl;
    return -1;
}
```

**参数说明：**
- `argv[1]`：hist文件路径
- `argv[2]`：run编号

#### 2. 读取ets_cut.txt文件

```cpp
// ========== 修改开始：使用环境变量 ROUND_NUMBER ==========
const char* round_num = getenv("ROUND_NUMBER");
string ets_cut_path;

if (round_num != NULL) {
    ets_cut_path = string("/besfs5/groups/cal/topup/round") + round_num + 
                   "/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt";
    cout << "INFO: Using ROUND_NUMBER=" << round_num << endl;
} else {
    ets_cut_path = "/besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt";
    cout << "WARNING: ROUND_NUMBER not set, using default round18" << endl;
}

cout << "INFO: Reading ets_cut file: " << ets_cut_path << endl;
// ========== 修改结束 ==========
```

**ETS_cut文件格式：**

```
run_num cut_down_1 cut_up_1 cut_down_2 cut_up_2 ...
```

**说明：**
- 每行代表一个run的ETS_cut窗口
- 第1列：run编号
- 第2-3列：第一个cut窗口的下限和上限
- 第4-5列：第二个cut窗口的下限和上限
- 以此类推...

#### 3. 解析ETS_cut窗口

```cpp
double read_info[1000];
double cut_down[1000];
double cut_up[1000];
double xmax[1000];
double xmin[1000];
int xbin = 500;
int num = 0;
string line1;
int flag_read;
char cut[1000][200];

for(int i=0;i<1000;i++){
    read_info[i]=0;
    cut_down[i]=0;
    cut_up[i]=0;
    xmax[i]=0;
    xmin[i]=0;
}

ifstream fin0(ets_cut_path.c_str());
if (!fin0.is_open()) {
    cout << "ERROR: Cannot open " << ets_cut_path << endl;
    return -1;
}

while(getline(fin0, line1)){
    flag_read = 0;
    double i = 0;
    int j = 0;
    istringstream ss1(line1);
    while(ss1>>i){
        read_info[j]=i;
        j++;
    }
    if(run==read_info[0]){
        num = (j-1)/2;
        for(int k=0;k<num;k++){
            cut_down[k]=read_info[2*k+1];
            cut_up[k]=read_info[2*k+2];
            xmin[k]=cut_down[k]-ceil(0.1*(cut_up[k]-cut_down[k]));
            xmax[k]=cut_up[k]+ceil(0.1*(cut_up[k]-cut_down[k]));
            sprintf(cut[k],"!(ets1/2000000>%.3f && ets1/2000000<%.3f)",cut_down[k],cut_up[k]);
        }
        flag_read = 1;
    }
    if(flag_read)  break;
}
fin0.close();
```

**解析过程：**
1. 读取ets_cut.txt文件的每一行
2. 找到对应run号的行
3. 解析cut窗口的上下限
4. 为每个cut窗口创建ROOT选择字符串

**cut字符串格式：**
```cpp
!(ets1/2000000>cut_down && ets1/2000000<cut_up)
```

**含义：**
- 过滤掉ETS值在cut_down和cut_up之间的事件
- 保留ETS值在此范围之外的事件

#### 4. 应用滤波窗口

```cpp
char basic_cut[200] = "trigChannel_9==0 && !((ets1-ets2_pre)/2000>0 && (ets1-ets2_pre)/2000<60 && flag_pre!=21)";
char connect[20] = " && ";
char *remove_cut =basic_cut;

for(int i=0;i<num;i++){
    remove_cut = Form("%s%s%s", remove_cut,connect,cut[i]);
}
```

**组合滤波条件：**

`remove_cut`最终包含：
1. `trigChannel_9==0`：触发通道9为0（正常触发）
2. `!((ets1-ets2_pre)/2000>0 && (ets1-ets2_pre)/2000<60 && flag_pre!=21)`：应用在线trigger veto
3. 所有的ETS_cut窗口（通过`&&`连接）

#### 5. 读取hist文件

```cpp
sprintf(fname, "%s/hist%05d.root", path, run);
if( (access(fname,0)) == -1) {
    cout<<"can not access file: "<<fname<<endl;
    return -1;
};

TFile f(fname);
TTree* tr = (TTree*)f.Get("event");
```

**hist文件内容：**
- `nhit_TQ_total_mdc`：MDC总击中数
- `ets1`：事件时间戳（ETS）
- `trigChannel_9`：触发通道9
- `ets2_pre`：前一个事件的ETS
- `flag_pre`：前一个事件的标志

#### 6. 生成原始分布

```cpp
int entries = tr->GetEntries();
double max_ets1 = double(tr->GetMaximum("ets1"));
int xbin2 =ceil(max_ets1/2000000);
double xmin2=0;
double xmax2 =max_ets1/2000000+0.1*max_ets1/2000000;
TH1F *hh1 = new TH1F("hh1","",xbin2,xmin2,xmax2);

for(int j=0;j<entries;j++){
    tr->GetEntry(j);

    if(!((ets1-ets2_pre)/2000>0 && (ets1-ets2_pre)/2000<60 && flag_pre!=21)){
        double y = ets1/2000000;
        if(trigChannel_9==0){
            hh1->Fill(y,nhit_TQ_total_mdc);
        }
    }
}
```

**说明：**
- 只处理不在在线trigger veto窗口内的事件
- 填充原始ETS vs MDC击中数的直方图

#### 7. 应用滤波并生成对比图

```cpp
TH2F *th1 = new TH2F("th1","",xbin2,xmin2,xmax2,ybin2,ymin2,ymax2); 
TH2F *th2 = new TH2F("th2","",xbin2,xmin2,xmax2,ybin2,ymin2,ymax2); 
TH2F *th3 = new TH2F("th3","",xbin2,xmin2,xmax2,ybin2,ymin2,ymax2); 
TH2F *th4 = new TH2F("th4","",xbin2,xmin2,xmax2,ybin2,ymin2,ymax2); 

tr->Project("th1","nhit_TQ_total_mdc:ets1/2000000",remove_cut);
tr->Project("th2","nhit_TQ_total_mdc:ets1/2000000",basic_cut);
tr->Project("th3","nhit_all_emc:ets1/2000000",remove_cut);
tr->Project("th4","nhit_all_emc:ets1/2000000",basic_cut);
```

**4个直方图：**
- `th1`：afterCut_ETS vs hit_TQ_MDC（应用ETS_cut滤波）
- `th2`：raw_ETS vs hit_TQ_MDC（原始，未应用ETS_cut滤波）
- `th3`：afterCut_ETS vs nhit_all_emc（应用ETS_cut滤波）
- `th4`：raw_ETS vs nhit_all_emc（原始，未应用ETS_cut滤波）

#### 8. 生成画布和输出

```cpp
TCanvas* c = new TCanvas ("c","c",1500,1200);
c->Divide(2,2);

c->cd(1);
hh1->Draw();
hh1->SetStats(0);
hh1->SetTitle(fname1);
hh1->GetXaxis()->SetTitle("afterCut_ETS(s)");
hh1->GetYaxis()->SetTitle("hit_TQ_MDC");

// 画cut窗口的边界线
double height3 = hh1->GetMaximum();
for(int i=0;i<num;i++){
    line_down[i] = new TLine(cut_down[i],0,cut_down[i],height3);
    line_up[i] = new TLine(cut_up[i],0,cut_up[i],height3);
    line_down[i]->Draw("Same");
    line_up[i]->Draw("Same");
    line_down[i]->SetLineWidth(2);
    line_up[i]->SetLineWidth(2);
    line_down[i]->SetLineColor(2);
    line_up[i]->SetLineColor(8);
}

c->cd(2);
hh1->Draw();
hh1->SetStats(0);
hh1->SetTitle(fname1);
hh1->GetXaxis()->SetTitle("raw_ETS(s)");
hh1->GetYaxis()->SetTitle("hit_TQ_MDC");

c->cd(3);
th1->SetTitle(fname1);
th1->SetStats(0);
th1->GetXaxis()->SetTitle("afterCut_ETS(s)");
th1->GetYaxis()->SetTitle("hit_TQ_MDC");
th1->Draw();

TLatex* a2 = new TLatex();
a2->SetNDC(1);
a2->SetTextSize(0.1);
a2->DrawLatex(0.15, 0.015, Form("windows:%d",num));

c->cd(4);
th2->SetTitle(fname1);
th2->SetStats(0);
th2->GetXaxis()->SetTitle("raw_ETS(s)");
th2->GetYaxis()->SetTitle("hit_TQ_MDC");
th2->Draw();

TLatex* a1 = new TLatex();
a1->SetNDC(1);
a1->SetTextSize(0.1);
a1->DrawLatex(0.15, 0.015, fname1);

c->Print(pngname);
c2->SaveAs(rootname);
```

**输出文件：**
- `run{run}.png`：对比图（2x2布局）
- `run{run}.root`：详细的ROOT文件

---

## 六、输出文件详解

### 1. run{run}.png

**格式：** PNG图片文件（2x2布局）

**内容：**

| 位置 | 内容 | 说明 |
|------|------|------|
| 左上 | afterCut_ETS vs hit_TQ_MDC | 应用ETS_cut滤波后的ETS vs MDC击中数 |
| 右上 | raw_ETS vs hit_TQ_MDC | 原始ETS vs MDC击中数（未滤波） |
| 左下 | afterCut_ETS vs nhit_TQ_MDC | 应用ETS_cut滤波后的ETS vs MDC击中数（2D图） |
| 右下 | raw_ETS vs nhit_TQ_MDC | 原始ETS vs MDC击中数（2D图，未滤波） |

**视觉效果：**
- 左上和右上图：对比滤波前后的MDC击中数分布
- cut窗口边界用红线和蓝线标出
- 左下和右下图：2D散点图，更直观地显示数据分布
- 右下角显示run编号
- 左下角显示cut窗口数量

**用途：**
- 人工审核滤波器效果
- 验证背景峰值是否被有效去除
- 检查数据是否被过度滤波

### 2. run{run}.root

**格式：** ROOT文件

**内容：**
- 所有直方图对象
- cut窗口信息
- 详细的统计信息

**用途：**
- 详细的数据分析
- 重新生成图片
- 存档和备份

---

## 七、步骤6的子步骤详解

### 步骤6.1：第六次作业提交与文件检查

**功能：**
- 清理旧文件（ETScut开头的文件、png文件、root文件）
- 执行genJob.sh脚本
- 检查生成的png和root文件是否完整

**关键特性：**

1. **清理旧文件：**
   ```bash
   rm -f ETScut* *png *root
   ```
   - 删除ETScut开头的文件（作业文件）
   - 删除所有png文件
   - 删除所有root文件
   - 确保干净的执行环境

2. **执行genJob.sh脚本：**
   - 遍历hist目录中的所有hist文件
   - 为每个hist文件创建作业配置文件
   - 提交作业到计算集群

3. **定时检查：**
   - 默认等待25分钟，每30秒检查一次
   - 支持通过参数自定义等待时间
   - 检查每个run是否生成了必需的文件：
     - `run{run}.png`
     - `run{run}.root`

4. **文件检查逻辑：**
   - 解析作业文件列表，提取run号
   - 检查每个run号的png和root文件
   - 记录未完成的run号
   - 显示检查进度

**支持submit_job参数：**

| submit_job值 | 行为 | 适用场景 |
|--------------|------|---------|
| True（默认） | 提交作业并检查文件 | 首次执行 |
| False | 跳过作业提交，只检查文件 | 重新检查 |

**示例运行：**

```bash
# 提交作业并检查（默认）
python run.py --step 6.1

# 只检查文件（不重新提交）
python run.py --step 6.1 --submit-job false

# 自定义等待时间
python run.py --step 6.1 --max-wait 30
```

### 步骤6.2：合并图片

**功能：**
- 进入check_ETScut_CalibConst目录
- 使用SL6容器执行ImageMagick的convert命令
- 将所有run*.png文件合并为一个PDF文件
- 下载PDF文件到本地

**技术细节：**

1. **容器环境：**
   - 使用`/cvmfs/container.ihep.ac.cn/bin/hep_container shell SL6`进入SL6容器
   - 容器中预装了ImageMagick工具

2. **图片合并：**
   - 使用`convert ./run*.png mergedd_ETS_checkall.pdf`命令
   - 按文件名顺序合并所有PNG图片
   - 输出文件名为`mergedd_ETS_checkall.pdf`

3. **文件下载：**
   - 使用SFTP协议下载PDF文件
   - 保存到本地`downloads/`目录
   - 文件名格式：`mergedd_ETS_checkall_{date}.pdf`

**用途：**
- 方便人工审核所有run的验证图片
- 可以快速浏览滤波器效果
- 便于存档和共享

**示例运行：**

```bash
# 执行步骤6.2
python run.py --step 6.2

# 指定日期
python run.py --step 6.2 --date 250519
```

---

## 八、第六次提交作业在离线事件滤波器中的作用

### 数据流程图

```
步骤5：ETS_cut校准
    ↓
ets_cut.txt（包含ETS_cut窗口）
    ↓
[步骤6.1：第六次作业提交]
    ├─ 清理旧文件
    ├─ 执行genJob.sh脚本
    │  ├─ 遍历hist目录
    │  ├─ 为每个hist创建作业
    │  └─ 提交作业到计算集群
    ├─ 运行checkCalibConst程序
    │  ├─ 读取hist文件
    │  ├─ 读取ets_cut.txt
    │  ├─ 应用ETS_cut滤波窗口
    │  ├─ 生成对比图
    │  └─ 保存PNG和ROOT文件
    └─ 检查文件是否完整
    ↓
run{run}.png（对比图）
run{run}.root（详细数据）
    ↓
[步骤6.2：合并图片]
    ├─ 进入容器
    ├─ 合并所有PNG为PDF
    └─ 下载到本地
    ↓
mergedd_ETS_checkall_{date}.pdf
    ↓
人工审核
    ↓
验证通过
    ↓
[步骤7：系统重置]
    ↓
[步骤8：提交数据库]
    ↓
滤波器参数在实际事件重建中使用
```

### 物理意义

通过第六次提交作业，我们可以：
1. **验证滤波有效性**：确认ETS_cut滤波器能够有效去除注入背景
2. **检查数据质量**：确保滤波后的数据符合物理分析要求
3. **优化滤波参数**：如果发现效果不佳，可以调整滤波窗口
4. **质量保证**：在提交数据库前进行最后的验证

### 与论文的对应

第六次提交作业对应论文中图5的 **"Offline Event Filter Calibration"** 框的验证阶段，是实现离线事件滤波器的质量保证步骤。

---

## 九、示例：run85383的完整流程

### 1. hist文件

```bash
/besfs5/groups/cal/topup/round18/DataValid/hist/hist85383.root
```

### 2. ets_cut.txt中的cut窗口

```
85383 0.5 1.5 2.5 3.5
```

**说明：**
- run85383有2个cut窗口
- 第1个窗口：0.5s - 1.5s
- 第2个窗口：2.5s - 3.5s

### 3. 作业配置文件（ETScut_check_85383.txt）

```
/besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/check_ETScut_CalibConst/a.out /besfs5/groups/cal/topup/round18/DataValid/hist 85383
```

### 4. 执行checkCalibConst程序

```bash
./a.out /besfs5/groups/cal/topup/round18/DataValid/hist 85383
```

**输出：**
```
INFO: Using ROUND_NUMBER=18
INFO: Reading ets_cut file: /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt
               85383
```

### 5. 生成的文件

**run85383.png：**
- 2x2布局的对比图
- 显示滤波前后的MDC击中数分布
- cut窗口边界用红线和蓝线标出

**run85383.root：**
- 包含所有直方图对象
- 详细的统计信息

### 6. 日志文件

**ETScut_check_85383.txt.out.52032427.0：**
```
INFO: Using ROUND_NUMBER=18
INFO: Reading ets_cut file: /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt
               85383
```

**ETScut_check_85383.txt.err.52032427.0：**
```
Info in <TCanvas::Print>: png file run85383.png has been created
Info in <TCanvas::SaveAs>: ROOT file run85383.root has been created
```

---

## 十、常见问题和解决方法

### 问题1：作业提交失败

**症状：**
```
执行genJob.sh脚本失败
```

**原因：**
- genJob.sh脚本不存在
- 环境变量未正确加载
- 目录权限不足

**解决方法：**
- 检查脚本是否存在：`ls -l genJob.sh`
- 检查环境变量：`echo $ROUND_NUMBER`
- 检查目录权限：`ls -ld .`

### 问题2：未找到作业文件

**症状：**
```
未找到作业文件
```

**原因：**
- hist目录为空
- hist文件命名不符合预期
- run编号解析错误

**解决方法：**
- 检查hist目录：`ls -lh /besfs5/groups/cal/topup/round18/DataValid/hist/`
- 检查hist文件命名：`ls hist*.root`
- 检查run编号提取逻辑

### 问题3：文件检查超时

**症状：**
```
在 25 分钟内未完成所有png和root文件的生成
```

**原因：**
- 计算集群负载高
- run数量多
- hist文件很大

**解决方法：**
- 增加等待时间：`python run.py --step 6.1 --max-wait 30`
- 检查作业状态：`hep_q -u topup`
- 重新提交失败的作业

### 问题4：ets_cut.txt文件不存在

**症状：**
```
ERROR: Cannot open /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt
```

**原因：**
- 步骤5未完成
- ets_cut.txt文件路径错误
- ROUND_NUMBER环境变量未设置

**解决方法：**
- 确保步骤5已完成
- 检查文件路径：`ls -lh /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/`
- 设置环境变量：`export ROUND_NUMBER=18`

### 问题5：图片合并失败

**症状：**
```
执行图片合并失败
```

**原因：**
- 容器环境问题
- ImageMagick未安装
- 没有可用的png文件

**解决方法：**
- 检查容器是否正常：`/cvmfs/container.ihep.ac.cn/bin/hep_container shell SL6`
- 检查ImageMagick是否可用：`convert --version`
- 检查png文件：`ls run*.png`

---

## 十一、总结

### 第六次提交作业的本质

第六次提交作业是 **BESIII离线事件滤波器校准流程的最后一步**，其核心任务是：

1. **验证滤波器效果**：对比应用滤波前后的MDC和EMC响应
2. **确认数据质量**：确保滤波后的数据符合物理分析要求
3. **质量保证**：在提交数据库前进行最后的验证
4. **为最终提交做准备**：验证通过后，滤波器参数将在实际事件重建中使用

### 关键技术点

1. **genJob.sh脚本**：自动化作业生成和提交
2. **checkCalibConst.cpp程序**：C++分析程序，应用滤波窗口并生成对比图
3. **ETS_cut滤波窗口**：从步骤5确定的滤波参数
4. **对比分析**：对比滤波前后的MDC和EMC响应
5. **定时检查机制**：确保作业完成
6. **图片合并**：方便人工审核

### 物理意义

通过第六次提交作业，我们可以：
1. **验证滤波有效性**：确认ETS_cut滤波器能够有效去除注入背景
2. **检查数据质量**：确保滤波后的数据符合物理分析要求
3. **优化滤波参数**：如果发现效果不佳，可以调整滤波窗口
4. **质量保证**：在提交数据库前进行最后的验证

### 验证标准

成功的第六次提交作业应该满足：
1. **背景峰值消失**：在cut窗口区域的背景峰值被有效去除
2. **数据保持完整**：正常事件的数据被完整保留
3. **响应分布正常**：滤波后的MDC和EMC响应分布符合预期
4. **无过度滤波**：不过度过滤正常的物理事件

### 未来改进方向

1. **自动化验证：**
   - 开发自动验证算法
   - 自动判断滤波器效果
   - 减少人工审核工作

2. **增强可视化：**
   - 提供更丰富的对比图
   - 添加统计分析图表
   - 支持交互式查看

3. **优化性能：**
   - 并行处理多个run
   - 优化内存使用
   - 减少处理时间

4. **改进用户体验：**
   - 提供更详细的验证报告
   - 支持批量验证
   - 提供异常告警

---

## 附录A：相关文件路径

### 远程服务器路径

```
/besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/check_ETScut_CalibConst/  # 工作目录
/besfs5/groups/cal/topup/round18/DataValid/hist/                                         # hist文件目录
/besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/                 # ets_cut文件目录
```

### 本地路径

```
C:\Users\孟皇薪\Desktop\topup\downloads\                    # 下载目录
C:\Users\孟皇薪\Desktop\topup\logs\                         # 日志目录
C:\Users\孟皇薪\Desktop\topup\.step_progress                # 进度文件
```

---

## 附录B：命令参考

### 执行步骤

```bash
# 执行步骤6.1（提交作业并检查）
python run.py --step 6.1

# 执行步骤6.1（只检查文件）
python run.py --step 6.1 --submit-job false

# 执行步骤6.2（合并图片）
python run.py --step 6.2

# 执行步骤6.2（指定日期）
python run.py --step 6.2 --date 250519

# 执行所有步骤（从步骤1开始）
python run.py --all --date 250519
```

### 查看作业状态

```bash
# 查看topup用户的作业
hep_q -u topup -g physics

# 查看所有用户的作业
hep_q -u

# 查看具体作业详情
hep_q -j <job_id>
```

### 手动操作

```bash
# 进入工作目录
cd /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/check_ETScut_CalibConst

# 提交作业
./genJob.sh

# 查看作业文件
ls ETScut_check_*.txt

# 查看生成的文件
ls run*.png
ls run*.root

# 检查ets_cut.txt文件
cat /besfs5/groups/cal/topup/round18/DataValid/Determining_ETS_cut/ETS_cut/ets_cut.txt

# 进入SL6容器
/cvmfs/container.ihep.ac.cn/bin/hep_container shell SL6

# 合并图片
convert ./run*.png mergedd_ETS_checkall.pdf

# 退出容器
exit

# 清理旧文件
rm -f ETScut* *png *root
```

---

## 附录C：术语表

| 术语 | 英文 | 含义 |
|------|------|------|
| ETS_cut | ETS Cut | ETS滤波窗口，用于过滤特定ETS范围的事件 |
| ETS | Event Time Stamp | 事件时间戳 |
| MDC | Main Drift Chamber | 主漂移室 |
| EMC | Electromagnetic Calorimeter | 电磁量能器 |
| hist | Histogram | 直方图，用于数据统计和可视化 |
| ROOT | ROOT Data Analysis Framework | ROOT数据分析框架 |
| hep_sub | High Energy Physics Submission | 高能物理作业提交命令 |
| a.out | Executable File | 可执行文件（checkCalibConst.cpp编译生成） |

---

## 附录D：与前五次作业的关系

### 作业流程回顾

```
步骤1：第一次作业提交
    ├─ 提取IST和ETS
    └─ 计算ΔT
    ↓
步骤2：第二次作业提交
    ├─ 生成hist文件
    └─ 分析MDC/EMC响应
    ↓
步骤3：第三次作业提交
    ├─ 检查shield文件
    └─ 运行add.sh脚本
    ↓
步骤4：第四次作业提交
    ├─ 检查shield效果
    └─ 生成checkShieldCalib图片
    ↓
步骤5：第五次作业提交
    ├─ 确定ETS_cut窗口
    ├─ 整理ets_cut.txt
    └─ 生成ETS_cut图片
    ↓
步骤6：第六次作业提交（本次）
    ├─ 验证ETS_cut效果
    └─ 生成对比图
    ↓
步骤7：系统重置
    ↓
步骤8：提交数据库
```

### 关联性说明

1. **依赖关系：**
   - 步骤6依赖步骤5生成的ets_cut.txt文件
   - 步骤6依赖步骤2生成的hist文件
   - 步骤6是整个流程的最后验证步骤

2. **数据流：**
   - 步骤1→步骤2：提供时间基准数据
   - 步骤2→步骤3：提供hist文件
   - 步骤3→步骤4：应用shield滤波
   - 步骤4→步骤5：确定ETS_cut窗口
   - 步骤5→步骤6：验证ETS_cut效果

3. **验证链：**
   - 步骤1-2：验证数据提取
   - 步骤3-4：验证shield滤波
   - 步骤5-6：验证ETS_cut滤波

---

**文档创建时间：** 2026年2月21日  
**基于论文：** "Suppression of top-up injection backgrounds with offline event filter in the BESIII experiment" (Radiation Detection Technology and Methods, 2022)  
**作者：** iFlow CLI
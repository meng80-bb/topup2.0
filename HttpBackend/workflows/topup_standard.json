{
  "workflow": {
    "name": "topup_standard_workflow",
    "display_name": "标准Topup数据处理流程",
    "description": "完整的数据处理流程，包含步骤1-8的所有子步骤",
    "version": "1.0.0",
    "author": "Topup Team",
    "created_at": "2025-02-23",
    "updated_at": "2025-02-23"
  },
  "execution": {
    "max_parallel_tasks": 5,
    "default_timeout_minutes": 30,
    "retry_on_failure": true,
    "max_retries": 3,
    "retry_delay_seconds": 60,
    "continue_on_error": false,
    "cleanup_on_success": false,
    "cleanup_on_failure": false
  },
  "environment": {
    "python_version": "3.8+",
    "required_modules": [
      "paramiko",
      "python-dotenv",
      "flask",
      "flask-cors",
      "flask-sqlalchemy"
    ]
  },
  "parameters": {
    "required": [
      "user_id",
      "date_param"
    ],
    "optional": [
      {
        "name": "submit_job",
        "type": "boolean",
        "default": true,
        "description": "是否提交作业到集群"
      },
      {
        "name": "max_wait_minutes",
        "type": "integer",
        "default": 25,
        "min": 5,
        "max": 120,
        "description": "最大等待时间（分钟）"
      },
      {
        "name": "skip_existing",
        "type": "boolean",
        "default": true,
        "description": "跳过已存在的步骤"
      }
    ]
  },
  "steps": [
    {
      "id": "step1_1",
      "order": 1,
      "display_name": "第一次作业提交并检查结果文件",
      "module": "step1_1_first_job_submission",
      "function": "step1_1_first_job_submission",
      "description": "对比两个目录找出最小的未处理日期，然后提交第一次作业，并检查结果文件",
      "timeout_minutes": 25,
      "retry_count": 3,
      "required_files": [
        "rec{run}_1.txt",
        "rec{run}_1.txt.bosserr",
        "rec{run}_1.txt.bosslog",
        "InjSigTime_00{run}_720.root",
        "Interval_run{run}.png",
        "Interval_run{run}.txt"
      ],
      "parameters": {
        "date": "date_param",
        "submit_job": "submit_job",
        "max_wait_minutes": "max_wait_minutes"
      },
      "success_criteria": {
        "all_files_exist": true,
        "no_anomaly_files": true
      },
      "on_failure": {
        "action": "stop",
        "notify": true
      }
    },
    {
      "id": "step1_2",
      "order": 2,
      "display_name": "移动文件",
      "module": "step1_2_move_files",
      "function": "step1_2_move_files",
      "description": "将处理好的文件移动到指定目录",
      "timeout_minutes": 5,
      "retry_count": 2,
      "required_files": [
        "rec*_1.txt",
        "rec*_1.txt.bosserr",
        "rec*_1.txt.bosslog",
        "InjSigTime_*.root",
        "Interval_*.png",
        "Interval_*.txt"
      ],
      "depends_on": ["step1_1"],
      "on_failure": {
        "action": "retry",
        "max_retries": 2
      }
    },
    {
      "id": "step1_3",
      "order": 3,
      "display_name": "IST分析",
      "module": "step1_3_ist_analysis",
      "function": "step1_3_ist_analysis",
      "description": "执行IST（Interval Signal Time）分析",
      "timeout_minutes": 60,
      "retry_count": 2,
      "required_files": [
        "hist_*/*.root"
      ],
      "depends_on": ["step1_2"],
      "on_failure": {
        "action": "stop",
        "notify": true
      }
    },
    {
      "id": "step1_4",
      "order": 4,
      "display_name": "合并图像",
      "module": "step1_4_merge_images",
      "function": "step1_4_merge_images",
      "description": "合并分析生成的图像",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_interval.png"
      ],
      "depends_on": ["step1_3"]
    },
    {
      "id": "step2_1",
      "order": 5,
      "display_name": "第二次作业提交",
      "module": "step2_1_second_job_submission",
      "function": "step2_1_second_job_submission",
      "description": "提交第二次作业，处理直方图数据",
      "timeout_minutes": 25,
      "retry_count": 3,
      "required_files": [
        "rec*_2.txt",
        "rec*_2.txt.bosserr",
        "rec*_2.txt.bosslog",
        "InjSigTime_*.root"
      ],
      "depends_on": ["step1_4"]
    },
    {
      "id": "step2_2",
      "order": 6,
      "display_name": "合并hist文件",
      "module": "step2_2_merge_hist",
      "function": "step2_2_merge_hist",
      "description": "合并hist文件",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_*.root"
      ],
      "depends_on": ["step2_1"]
    },
    {
      "id": "step2_3",
      "order": 7,
      "display_name": "生成PNG文件",
      "module": "step2_3_generate_png",
      "function": "step2_3_generate_png",
      "description": "从hist文件生成PNG可视化文件",
      "timeout_minutes": 15,
      "retry_count": 2,
      "required_files": [
        "*.png"
      ],
      "depends_on": ["step2_2"]
    },
    {
      "id": "step2_4",
      "order": 8,
      "display_name": "检查PNG文件",
      "module": "step2_4_check_png_files",
      "function": "step2_4_check_png_files",
      "description": "检查生成的PNG文件是否完整",
      "timeout_minutes": 5,
      "retry_count": 2,
      "required_files": [
        "interval_run*.png"
      ],
      "depends_on": ["step2_3"]
    },
    {
      "id": "step2_5",
      "order": 9,
      "display_name": "合并图像",
      "module": "step2_5_merge_images",
      "function": "step2_5_merge_images",
      "description": "合并所有interval和hist图像",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_interval_hist.png"
      ],
      "depends_on": ["step2_4"]
    },
    {
      "id": "step3_1",
      "order": 10,
      "display_name": "第三次作业提交",
      "module": "step3_1_third_job_submission",
      "function": "step3_1_third_job_submission",
      "description": "提交第三次作业，确定50Hz cut，寻找峰值",
      "timeout_minutes": 30,
      "retry_count": 3,
      "required_files": [
        "run_*_3.txt",
        "*.err",
        "*.out",
        "shield_run*.txt"
      ],
      "depends_on": ["step2_5"]
    },
    {
      "id": "step3_2",
      "order": 11,
      "display_name": "运行添加脚本",
      "module": "step3_2_run_add_script",
      "function": "step3_2_run_add_script",
      "description": "运行添加shield脚本",
      "timeout_minutes": 15,
      "retry_count": 2,
      "required_files": [
        "shield_run*.txt",
        "shield_run*.png"
      ],
      "depends_on": ["step3_1"]
    },
    {
      "id": "step4_1",
      "order": 12,
      "display_name": "第四次作业提交",
      "module": "step4_1_fourth_job_submission",
      "function": "step4_1_fourth_job_submission",
      "description": "提交第四次作业，检查shield校准",
      "timeout_minutes": 30,
      "retry_count": 3,
      "required_files": [
        "*.txt",
        "*.err",
        "*.out",
        "*.png"
      ],
      "depends_on": ["step3_2"]
    },
    {
      "id": "step4_2",
      "order": 13,
      "display_name": "合并图像",
      "module": "step4_2_merge_images",
      "function": "step4_2_merge_images",
      "description": "合并shield校准图像",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_shield.png"
      ],
      "depends_on": ["step4_1"]
    },
    {
      "id": "step5_1",
      "order": 14,
      "display_name": "第五次作业提交",
      "module": "step5_1_fifth_job_submission",
      "function": "step5_1_fifth_job_submission",
      "description": "提交第五次作业，确定ETS cut",
      "timeout_minutes": 30,
      "retry_count": 3,
      "required_files": [
        "plot_ETS_*.txt",
        "*.err",
        "*.out",
        "run*_cut.png",
        "run*_total.png"
      ],
      "depends_on": ["step4_2"]
    },
    {
      "id": "step5_2",
      "order": 15,
      "display_name": "运行添加shield脚本",
      "module": "step5_2_run_add_shield_script",
      "function": "step5_2_run_add_shield_script",
      "description": "运行添加shield脚本",
      "timeout_minutes": 15,
      "retry_count": 2,
      "required_files": [
        "shield_run*.txt",
        "shield_run*.png"
      ],
      "depends_on": ["step5_1"]
    },
    {
      "id": "step5_3",
      "order": 16,
      "display_name": "组织ETS cut文件",
      "module": "step5_3_organize_ets_cut_file",
      "function": "step5_3_organize_ets_cut_file",
      "description": "组织ETS cut文件",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "cut*.root",
        "run*.cut",
        "merged_cut*.txt"
      ],
      "depends_on": ["step5_2"]
    },
    {
      "id": "step5_4",
      "order": 17,
      "display_name": "合并图像",
      "module": "step5_4_merge_images",
      "function": "step5_4_merge_images",
      "description": "合并ETS cut图像",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_cut*.png"
      ],
      "depends_on": ["step5_3"]
    },
    {
      "id": "step6_1",
      "order": 18,
      "display_name": "第六次作业提交",
      "module": "step6_1_sixth_job_submission",
      "function": "step6_1_sixth_job_submission",
      "description": "提交第六次作业，检查ETS cut校准",
      "timeout_minutes": 30,
      "retry_count": 3,
      "required_files": [
        "ETScut_check_*.txt",
        "*.err",
        "*.out",
        "*.png",
        "*.root"
      ],
      "depends_on": ["step5_4"]
    },
    {
      "id": "step6_2",
      "order": 19,
      "display_name": "合并图像",
      "module": "step6_2_merge_images",
      "function": "step6_2_merge_images",
      "description": "合并ETS cut校准图像",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "merged_etscut.png"
      ],
      "depends_on": ["step6_1"]
    },
    {
      "id": "step7",
      "order": 20,
      "display_name": "运行重置脚本",
      "module": "step7_run_reset_script",
      "function": "step7_run_reset_script",
      "description": "运行重置脚本",
      "timeout_minutes": 10,
      "retry_count": 2,
      "required_files": [
        "reset_*.txt"
      ],
      "depends_on": ["step6_2"]
    },
    {
      "id": "step8",
      "order": 21,
      "display_name": "提交到数据库",
      "module": "step8_submit_injsiginterval_db",
      "function": "step8_submit_injsiginterval_db",
      "description": "提交InjSigInterval到数据库",
      "timeout_minutes": 45,
      "retry_count": 3,
      "required_files": [
        "*.root",
        "*.txt"
      ],
      "depends_on": ["step7"],
      "on_success": {
        "action": "cleanup",
        "cleanup_patterns": [
          "*.tmp",
          "*.bak"
        ]
      }
    }
  ],
  "notifications": {
    "on_start": {
      "enabled": true,
      "message": "任务 {task_name} 开始执行"
    },
    "on_complete": {
      "enabled": true,
      "message": "任务 {task_name} 执行完成，耗时 {duration}秒"
    },
    "on_failure": {
      "enabled": true,
      "message": "任务 {task_name} 执行失败，错误：{error}"
    },
    "on_step_complete": {
      "enabled": false,
      "message": "步骤 {step_name} 完成"
    }
  },
  "output": {
    "base_dir": "/besfs5/groups/cal/topup/{round}/DataValid",
    "download_dir": "./downloads",
    "archive_dir": "./archives",
    "max_archive_size_mb": 1000
  }
}